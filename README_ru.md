| Имя | Tron, автоматический скрипт для очистки ПК |
| :--- | :--- |
| Автор | vocatus на [old.reddit.com/r/TronScript](https://old.reddit.com/r/tronscript) (`vocatus.gate@gmail`) // PGP: [0x07d1490f82a211a2](http://pool.sks-keyservers.net:11371/pks/lookup?op=get&search=0x07D1490F82A211A2) |
| Происхождение | Почему такое название? Tron "Борется за пользователя" |

# НЕ СКАЧИВАЙТЕ TRON С GITHUB, ОН НЕ БУДЕТ РАБОТАТЬ!! ВАМ НУЖЕН ПОЛНЫЙ ПАКЕТ ИЗ [r/TronScript](https://old.reddit.com/r/TronScript)

Мне надоело запускать эти утилиты вручную, и я решил просто написать скрипт. Tron - это отличная коллекция пакетных файлов, которые автоматизируют процесс очистки и дезинфекции Windows-машин ([Общие вопросы](https://www.reddit.com/r/TronScript/wiki/index#wiki_cq_.28common_questions.29)). Он строится с учетом мнения сообщества и регулярно обновляется.

# Содержание

1. [Краткое описание использования](#Использование)

2. [Работа с командной строкой](#Использование-в-командной-строке)

3. [Прерывание работы](#Прерывание-сценария)

4. [Заметки по Безопасному режиму](#Безопасный-режим)

5. [Отправка отчета о проделанной работе по электронной почте](#Email-отчет)

6. [Изменение стандартных параметров](#Изменение-настроек-по-умолчанию-для-продвинутых)

7. [Выполнение пользовательских/сторонних сценариев](#Выполнение-пользовательских-скриптов)

8. [Выполнение поставляемых обновлений WSUS Offline](#Выполнение-оффлайн-обновлений-wsus-offline)

9. [Целостность](#Целостность)

10. [Лицензия](#Лицензия)

11. [Возможные трудности и поддержка](#problems-and-support)

12. [Коды выхода скрипта](#script-exit-codes) 

13. [Полное описание ВСЕХ действий](#full-tron-description)


# ИСПОЛЬЗОВАНИЕ

0. СНАЧАЛА: **ПЕРЕЗАГРУЗИТЕ КОМПЬЮТЕР ПЕРЕД ЗАПУСКОМ TRON.** Это необходимо для завершения всех ожидающих обновлений. Если вы этого не сделаете, и компьютер перезагрузится во время выполнения Tron с ожидающими обновлениями, это может привести к блокировке системы. Повторю: очень важно перезагрузить компьютер перед запуском Tron.

1. [Загрузите Tron](https://old.reddit.com/r/TronScript/). Ссылки для загрузки находятся в верхнем сообщении в [/r/TronScript](https://old.reddit.com/r/TronScript). Если вы загрузили исполняемый файл `.exe`, запустите его, и он извлечет файл `tron.bat` и папку `\resources` в текущий каталог. Скопируйте оба файла на **Рабочий стол** целевой машины.

2. Tron можно запустить в Windows как в безопасном режиме, так и в обычном режиме. Обычный режим рекомендуется, если система серьезно заражена.

3. Щелкните правой кнопкой мыши по файлу `tron.bat` и выберите "**Запуск от имени администратора**"

4. Подождите от **3 до 10 часов** (это действительно занимает столько времени; **не** отменяйте его посередине выполнения)

   *Примечание: Вам нужно будет вручную нажать "Сканировать" в окне MBAM, которое появится на этапе 3: Дезинфекция. Tron будет продолжать выполнение других задач в фоновом режиме, ожидая вашего ответа, поэтому скрипт не остановится, если вы не сможете сразу нажать "Сканировать".*

5. **Перезагрузите!** Перезагрузите систему перед выполнением *любых других действий*.

По умолчанию основной журнал находится по пути `C:\logs\tron\tron.log`. Если вы хотите изменить это, прочтите раздел ниже о изменении настроек по умолчанию.

В зависимости от того, насколько система заражена, выполнение может занять от 3 до 10 часов. Я лично наблюдал время от 4 до 8 часов, и один пользователь сообщил о времени выполнения 30 часов. Просто запустите и забудьте.

Если вы запустите с ключом `-udl`, в конце сценария он автоматически отправит мне журналы выполнения по электронной почте. Не обязательно, но если вы можете, это будет очень ценно.

**ПРИМЕЧАНИЕ:** Каждый подскрипт этапа (например, `stage_2_de-bloat.bat`) может быть запущен отдельно от Tron. Просто не забывайте запускать их от имени администратора, если вы выбираете этот путь.

# ИСПОЛЬЗОВАНИЕ В КОМАНДНОЙ СТРОКЕ

Полная поддержка использования в командной строке. Все переключатели являются необязательными и могут использоваться одновременно. *

    tron.bat [ [-a | -asm] -c -d -dev -e -er -m -o -p -pmb -r -sa -sac -sap -scc -scs -sd -sdb
          -sdc -sdu -se -sk -sl -sm -sor -spr -ss -str -swu -swo -udl -v -x] | [-h]

    Необязательные параметры (их можно комбинировать):

     -a   Автоматический режим (без приветственного экрана или подсказок; подразумевает -e)
     
     -asm Автоматический режим (без подсказок; подразумевает -e; перезагружает в безопасный режим)

     -c   Выгрузка конфигурации (отображение текущей конфигурации. Может использоваться с другими
          параметрами, чтобы увидеть, что БЫ произошло, но скрипт никогда не выполнится,
          если этот переключатель используется)

     -d   Пробный запуск (запустить скрипт без выполнения каких-либо заданий)
    
     -dev Переопределение обнаружения ОС (разрешает запуск на не поддерживаемых версиях Windows)

     -e   Принять условия лицензионного соглашения (подавить экран предупреждения об отказе от ответственности)

     -er  Отправить отчет по электронной почте по завершении. Требует настройки SwithMailSettings.xml

     -m   Сохранить стандартные приложения Metro (не удалять их)

     -o   Выключить после выполнения (переопределяет -r)

     -p   Сохранить настройки энергосбережения (не возвращаться к стандартным настройкам Windows)

     -pmb Сохранить Malwarebytes (не удалять его) после завершения работы Tron
     
     -r   Автоматическая перезагрузка (автоматическая перезагрузка через 15 секунд после завершения)
     
     -sa  Пропустить ВСЕ антивирусные сканирования (AdwCleaner, KVRT, MBAM, SAV)

     -sac Пропустить сканирование AdwCleaner

     -sap Пропустить установку патчей для приложений (не патчить 7-Zip)

     -scs Пропустить пользовательские скрипты (не имеет эффекта, если вы не предоставили пользовательские скрипты)

     -scc Пропустить очистку куки (не рекомендуется, Tron автоматически сохраняет большинство обычных куки входа)

     -sd  Пропустить дефрагментацию (принудительно пропустить дефрагментацию этапа 6)

     -sdb Пропустить де-блокировку (весь процесс удаления OEM-блокировки; подразумевает -m)
     
     -sdc Пропустить очистку компонента DISM (хранилища SxS)
     
     -sdu Пропустить обновление де-блокировки. Предотвращает автоматическое обновление списков де-блокировки S2

     -se  Пропустить резервное копирование и очистку журнала событий (не очищать журналы событий Windows)

     -sk  Пропустить сканирование Kaspersky Virus Rescue Tool (KVRT)

     -sm  Пропустить установку Malwarebytes Anti-Malware (MBAM)

     -sor Пропустить удаление OneDrive, независимо от того, используется он или нет

     -spr Пропустить сброс файла подкачки (не устанавливать "Позволить Windows управлять файлом подкачки")

     -ss  Пропустить сканирование Sophos Anti-Virus (SAV)

     -str Пропустить удаление телеметрии (просто отключите телеметрию, а не удаляйте ее)

     -swu Пропустить обновления Windows полностью (игнорировать как WSUS Offline, так и онлайн методы)

     -swo Пропустить предоставленные пользователем обновления WSUS Offline (если они есть; онлайн обновления все равно выполняются)
     
     -udl Загрузить отладочные журналы. Отправить tron.log и дамп идентификатора системы разработчику Tron

     -v   Развернутый режим. Показывать как можно больше вывода. ПРИМЕЧАНИЕ: Значительно медленнее!

     -x   Автоудаление. Tron удаляет себя после выполнения и оставляет журналы нетронутыми

    Различные параметры (должны использоваться отдельно):

     -h   Показать текст справки


\* Вероятно, нет параметра `-upm`

# ПРЕРЫВАНИЕ СЦЕНАРИЯ

Если сценарий прерывается, например, из-за сбоя или принудительной перезагрузки (часто возникающей на этапе_2_разблокировка), просто повторно запустите `tron.bat`, и Tron возобновит выполнение с последнего успешно запущенного этапа.

Он также повторно использует все ранее использованные параметры командной строки при следующем запуске.

Более подробные сведения об этой функции можно найти в [списке всех действий, выполняемых Tron](#full-tron-description) в конце этого документа.

# БЕЗОПАСНЫЙ РЕЖИМ

В старых версиях Tron (v10.3.1 и ранее) рекомендовался использовать безопасный режим по сравнению с нормальным/обычным режимом (режим загрузки Windows). Текущее рекомендуемое действие изменилось, начиная с v10.4.0, и я рекомендую сначала запускать в нормальном/обычном режиме, и пытаться запустить в безопасном режиме только в случае неудачи.

# EMAIL-ОТЧЕТ

Чтобы Tron отправил отчет по электронной почте по завершении, отредактируйте этот файл:

    \tron\resources\stage_7_wrap-up\email_report\SwithMailSettings.xml

Укажите ваш SMTP-сервер, имя пользователя и пароль. После указания ваших настроек вы можете использовать переключатель `-er`, чтобы Tron отправил отчет по электронной почте. Сводные журналы (`tron_removed_files.txt` и `tron_removed_programs.txt`) также будут прикреплены.

Имейте в виду, что имя пользователя и пароль для учетной записи электронной почты будут храниться в ОБЫЧНОМ ТЕКСТЕ, поэтому не оставляйте их в системе, которой вы не доверяете.

# ИЗМЕНЕНИЕ НАСТРОЕК ПО УМОЛЧАНИЮ (для продвинутых)

Если вы не хотите использовать командную строку и вам не нравятся настройки Tron по умолчанию, вы можете изменить следующие настройки по умолчанию. Имейте в виду, что переключатели командной строки всегда переопределяют соответствующий параметр по умолчанию при использовании.

**Отредактируйте этот файл**: `\tron\resources\functions\tron_settings.bat`

- Чтобы изменить основной каталог, куда Tron выводит все свои данные, отредактируйте эту строку:
  ```bat
  set LOGPATH=%SystemDrive%\logs\tron
  ```

- Чтобы изменить имя основного файла журнала, отредактируйте эту строку:
  ```bat
  set LOGFILE=tron.log
  ```

- Чтобы изменить местоположение файлов, помещенных в карантин Tron (обратите внимание: в настоящее время Tron не использует это, установка не имеет эффекта):
  ```bat
  set QUARANTINE_PATH=%LOGPATH%\quarantine
  ```

- Чтобы изменить расположение резервных копий, создаваемых Tron (реестр, журналы событий, схема питания и т. д.), отредактируйте эту строку:
  ```bat
  set BACKUPS=%LOGPATH%\backups
  ```

- Чтобы изменить место, где Tron сохраняет необработанные журналы из различных подскриптов, отредактируйте эту строку:
  ```bat
  set RAW_LOGS=%LOGPATH%\raw_logs
  ```

- Чтобы изменить, где Tron сохраняет сводные журналы, отредактируйте эту строку:
  ```bat
  set SUMMARY_LOGS=%LOGPATH%\summary_logs
  ```

- Чтобы всегда запускать автоматически (без приветственного экрана, подразумевает принятие EULA), измените это на `yes`:
  ```bat
  set AUTORUN=no
  ```
  
- Чтобы всегда перезагружаться в безопасном режиме для автозапуска (требуется, чтобы AUTORUN также был установлен в `yes`), измените это на `yes`:
  ```bat
  set AUTORUN_IN_SAFE_MODE=no
  ```

- Чтобы выполнить пробный запуск (фактически не выполнять задания), измените это на `yes`:
  ```bat
  set DRY_RUN=no
  ```

- Чтобы переопределить обнаружение ОС (разрешить Tron запускаться на не поддерживаемых версиях Windows), измените это на `yes`:
  ```bat
  set DEV_MODE=no
  ```

- Чтобы постоянно принимать Лицензионное соглашение конечного пользователя (подавлять отображение предупреждения об отказе от ответственности), измените это на `yes`:
  ```bat
  set EULA_ACCEPTED=no
  ```

- Чтобы иметь Tron отправлять отчет по электронной почте по завершении, измените это на `yes` (требует настройки `SwithMailSettings.xml` с вашей информацией SMTP):
  ```bat
  set EMAIL_REPORT=no
  ```

- Чтобы сохранить стандартные приложения Metro (не удалять их), измените это на `yes`:
  ```bat
  set PRESERVE_METRO_APPS=no
  ```

- Чтобы выключить компьютер по завершении Tron, измените это на `yes`:
  ```bat
  set AUTO_SHUTDOWN=no
  ```

- Чтобы сохранить схему энергосбережения (вместо сброса на стандарты Windows), измените это на `yes`:
  ```bat
  set PRESERVE_POWER_SCHEME=no
  ```

- Чтобы сохранить установку Malwarebytes (пропустить удаление) после завершения Tron, измените это на `yes`:
  ```bat
  set PRESERVE_MALWAREBYTES=no
  ```

- Чтобы настроить перезагрузку после выполнения, измените это значение (в секундах). `0` отключает автоматическую перезагрузку:
  ```bat
  set AUTO_REBOOT_DELAY=0
  ```

- Чтобы пропустить ВСЕ движки антивирусного сканирования (AdwCleaner, MBAM, KVRT, Sophos), измените это на `yes`:
  ```bat
  set SKIP_ANTIVIRUS_SCANS=no
  ```

- Чтобы пропустить сканирование AdwCleaner, измените это на `yes`:
  ```bat
  set SKIP_ADWCLEANER_SCAN=no
  ```

- Чтобы пропустить патчи для приложений (не патчить 7-Zip или Adobe Flash), измените это на `yes`:
  ```bat
  set SKIP_APP_PATCHES=no
  ```

- Чтобы оставить ВСЕ куки нетронутыми (не рекомендуется, Tron автоматически сохраняет большинство обычных куки для входа, таких как Spotify, Gmail и т. д.), измените это на `yes`:
  ```bat
  set SKIP_COOKIE_CLEANUP=no
  ```

- Чтобы пропустить пользовательские сценарии (этап 8), независимо от того, присутствуют ли файлы `.bat` в папке `stage_8_custom_scripts`, измените это на `yes`:
  ```bat
  set SKIP_CUSTOM_SCRIPTS=no
  ```

- Чтобы пропустить OEM-разгрузку, измените это на `yes`:
  ```bat
  set SKIP_DEBLOAT=no
  ```

- Чтобы всегда пропускать дефрагментацию (даже на механических дисках; Tron автоматически пропускает дефрагментацию SSD), измените это на `yes`:
  ```bat
  set SKIP_DEFRAG=no
  ```
  
- Чтобы пропустить очистку компонентов DISM (SxS store), измените это на `yes`:
  ```bat
  set SKIP_DISM_CLEANUP=no
  ```
  
- Чтобы предотвратить подключение Tron к Github и автоматическое обновление списков разгрузки 2 этапа, установите это на `yes`:
  ```bat
  set SKIP_DEBLOAT_UPDATE=no
  ```

- Чтобы пропустить очистку журналов событий Windows, измените это на `yes`:
  ```bat
  set SKIP_EVENT_LOG_CLEAR=no
  ```

- Чтобы пропустить сканирование с Kaspersky Virus Rescue Tool (KVRT), измените это на `yes`:
  ```bat
  set SKIP_KASPERSKY_SCAN=no
  ```

- Чтобы пропустить установку Malwarebytes Anti-Malware (MBAM), измените это на `yes`:
  ```bat
  set SKIP_MBAM_INSTALL=no
  ```

- Чтобы пропустить удаление OneDrive, независимо от того, используется он или нет, измените это на `yes`:
  ```bat
  set SKIP_ONEDRIVE_REMOVAL=no
  ```

- Чтобы предотвратить сброс Tron настроек файла подкачки к стандартам Windows, измените это на `yes`:
  ```bat
  set SKIP_PAGEFILE_RESET=no
  ```

- Чтобы пропустить сканирование с Sophos Anti-Virus (SAV), измените это на `yes`:
  ```bat
  set SKIP_SOPHOS_SCAN=no
  ```
  
- Чтобы пропустить удаление обновлений Windows "телеметрии" (отслеживание пользователей), измените это на `yes`:
  ```bat
  set SKIP_TELEMETRY_REMOVAL=no
  ```

- Чтобы пропустить только пакетные обновления WSUS Offline (попытки выполнения обновлений онлайн сохраняются), измените это на `yes`:
  ```bat
  set SKIP_WSUS_OFFLINE=no
  ```

- Чтобы полностью пропустить обновления Windows (игнорировать как WSUS Offline, так и онлайн методы), измените это на `yes`:
  ```bat
  set SKIP_WINDOWS_UPDATES=no
  ```
  
- Чтобы автоматически загружать отладочные журналы разработчику Tron (vocatus), измените это на `yes`:
  ```bat
  set UPLOAD_DEBUG_LOGS=no
  ```

- Чтобы показать как можно больше вывода (подробности), измените это на `yes`:
  ```bat
  set VERBOSE=no
  ```

- Чтобы Tron удалил сам себя после выполнения (самоуничтожение), измените это на `yes`:
  ```bat
  set SELF_DESTRUCT=no
  ```

* Скорее всего, параметра `-UPM` нет

# ВЫПОЛНЕНИЕ ПОЛЬЗОВАТЕЛЬСКИХ СКРИПТОВ:

Tron поддерживает выполнение пользовательских скриптов непосредственно перед экраном завершения.

Разместите все файлы пакетных команд, которые вы хотите выполнить непосредственно перед завершением Tron, в этой папке: `\tron\resources\stage_8_custom_scripts`

Пользовательские скрипты работают следующим образом:

 - Если в папке `\stage_8_custom_scripts` существуют файлы с расширением `.bat`, Tron выполнит каждый из них последовательно по имени. По завершении выполнения Tron выполнит очистку и завершит сценарий как обычно.

 - Если в папке `\stage_8_custom_scripts` нет файлов с расширением `.bat`, этап 8 молча пропускается.

 - Поддерживающие файлы могут быть помещены в папку, но сам Tron игнорирует все, что не является файлом с расширением `.bat`

 - Если вы хотите использовать вспомогательные файлы пакетных команд, но не хотите, чтобы Tron выполнял их, используйте расширение файла `.cmd` вместо `.bat`, и Tron их проигнорирует.

 - Это ваша ответственность, что делают ваши скрипты. Я не предоставляю поддержку для пользовательских скриптов, кроме как попытки Tron выполнить их.

 - Используйте переключатель `-scs` или отредактируйте файл `\tron\resources\functions\tron_settings.bat` и установите `SKIP_CUSTOM_SCRIPTS` в `yes`, чтобы указать Tron игнорировать пользовательские скрипты, даже если они присутствуют. Может быть полезно, если у вас есть набор скриптов, которые вы хотите выполнить только на определенных системах, и вы не хотите носить две копии Tron с собой.

# ВЫПОЛНЕНИЕ ОФФЛАЙН-ОБНОВЛЕНИЙ WSUS OFFLINE

Tron поддерживает использование пакетов обновлений WSUS Offline вместо традиционного метода обновления онлайн.

Чтобы добавить оффлайн-пакеты обновлений в Tron:

1. Скачайте [WSUS Offline](http://download.wsusoffline.net/)

2. Запустите его и загрузите необходимые обновления

3. Скопируйте папку `client` (обычно находится в `\wsusoffline\client`) в `\tron\resources\stage_5_patch\wsus_offline\client\`

4. Убедитесь, что в этом пути присутствует файл `Update.cmd`: `\tron\resources\stage_5_patch\wsus_offline\client\Update.cmd`

5. Запустите Tron, он должен автоматически обнаружить и использовать оффлайн-обновления

Если по какой-то причине вы хотите пропустить пакет обновлений на определенной системе, используйте переключатель `-swo` или отредактируйте [tron_settings.bat](https://github.com/bmrf/tron/blob/master/resources/functions/tron_settings.bat), установите `SKIP_WSUS_OFFLINE` в yes, и Tron проигнорирует любые файлы WSUS Offline в этом запуске.
 
# ЦЕЛОСТНОСТЬ

В каждом выпуске файл `\tron\integrity_verification\checksums.txt` содержит хеши SHA-256 *каждого* файла, включенного в Tron, и подписан моим [PGP-ключом](http://pool.sks-keyservers.net:11371/pks/lookup?op=get&search=0x07D1490F82A211A2) (`0x07d1490f82a211a2`, включен). Вы можете использовать его для проверки целостности пакета.

# ЛИЦЕНЗИЯ

Tron и все включенные подскрипты и файлы `.reg`, написанные мной, предоставляются бесплатно для использования/распространения/чего угодно в рамках **лицензии MIT**. Было бы здорово, если бы вы отправили электронное письмо и дали мне знать, если вы сделали что-то интересное с этим, но это не обязательно. Все сторонние утилиты, которые вызывает Tron (MBAM, TDSSK и т. д.), подчиняются своим соответствующим лицензиям. Ваша ответственность - определить, можете ли вы использовать их в вашей конкретной ситуации.

# ПРОБЛЕМЫ И ПОДДЕРЖКА

Пожалуйста, сначала [посетите](https://old.reddit.com/r/TronScript/wiki/index#wiki_cq_.28common_questions.29) для списка распространенных проблем (Tron кажется зависшим и т. д.). Если это не решает вашу проблему, создайте пост на [r/TronScript](https://old.reddit.com/r/TronScript), и я или один из членов сообщества рассмотрим проблему. Кроме того, вы можете связаться со мной 24/7 [на Keybase](https://keybase.io/vocatus).

Надеюсь, это будет полезно другим специалистам по обслуживанию ПК,

– Vocatus

Если вы можете, пожертвования принимаются по следующим адресам:

Bitcoin: `1Biw8gx2kD7mZf66ZdNgB9tG1pE9YA3kEd`

Bitcoin Cash: `18sXTTrAViPZVQtm63zBK6aCK3XfJpEThk`

# КОДЫ ВЫХОДА СЦЕНАРИЯ
При завершении работы Tron передаст код выхода, указывающий на окончательный статус (успех/предупреждение/ошибка/сбой и т. д.).

| КОД       | ЗНАЧЕНИЕ |
| :--------- | :------ |
| 0 | Успех
| 1 | Ошибка (обычно фатальная)
| 2 | Предупреждение (не фатальное)
| 3 | Неподдерживаемая ОС (запустите с `-dev` для отмены)
| 4 | Выход с ожиданием перезагрузки
| 5 | Пользователь — идиот (вы попытались запустить из временного каталога, несмотря на инструкции, явно указывающие на обратное)

# ПОЛНОЕ ОПИСАНИЕ TRON
Лучший способ узнать, что делает Tron, — просто открыть [tron.bat](https://github.com/bmrf/tron/blob/master/tron.bat) или один из подскриптов для конкретного этапа с помощью текстового редактора (желательно с подсветкой синтаксиса) или [на GitHub](https://github.com/bmrf/tron/blob/master/tron.bat) и просто прочитать код. В каждом разделе есть комментарии, объясняющие, что именно делает Tron, и вам не нужно уметь читать код, чтобы его понять. За исключением этого вот общее описание каждого действия, выполняемого Tron.

## tron.bat

*[ссылка на код](https://github.com/bmrf/tron/blob/master/tron.bat)*

Главный скрипт, который запускает все остальное. Он выполняет множество действий самостоятельно, но для любой задачи, не выполняемой напрямую, мы вызываем внешнюю утилиту или скрипт. Каждый этап (например, Этап 1: Очистка временных файлов) имеет свой главный скрипт, который Tron вызывает последовательно. Подскрипты можно найти в каждом подкаталоге каждого этапа в папке `\resources`. Например, `\tron\resources\stage_1_tempclean\stage_1_tempclean.bat`

## Внутренние задания Tron
(Эти выполняются даже если Tron отменен до запуска)

0. **Обнаружение выполнения из TEMP-каталога**: Обнаруживает, выполняется ли Tron из каталога TEMP, и предотвращает выполнение Tron, если это так. TEMP — одно из первых мест, которые очищаются при запуске Tron, поэтому мы не можем выполнять его оттуда.

1. **Создание каталогов для журналов**: Создает главный каталог журнала и подкаталоги, если они не существуют. По умолчанию это `%SystemDrive%\Logs\tron.log`

2. **Обнаружение версий Windows и IE**: Определяет много вещей в скрипте, таких как версии различных команд, которые будут выполнены.

3. **Блокировка неподдерживаемой ОС**: Выводит сообщение-оповещение, если запускается на неподдерживаемой ОС, затем завершает работу. Используйте переключатель `-dev`, чтобы переопределить это поведение и разрешить выполнение на неподдерживаемых версиях Windows. В настоящее время срабатывает только на Windows Server 2016.

4. **Проверка конфигурации диска**: Проверяет, является ли системный диск SSD, виртуальным диском или вызывает неуточненную ошибку (не может быть прочитан `smartctl.exe`) и устанавливает переменную `SKIP_DEFRAG` в `yes_ssd`, `yes_vm` или `yes_error` соответственно. Если хотя бы одно из этих условий срабатывает, Tron автоматически пропускает **Этап 5 дефрагментации**.

5. **Обнаружение свободного места**: Обнаруживает и сохраняет доступное место на жестком диске для последующего сравнения. Просто используется для отображения того, сколько места было восстановлено; не влияет на функции скрипта.

6. **Обнаружение возобновления**: Обнаруживает, выполняем ли мы возобновление после прерывания (например, после перезагрузки).

7. **Включение выбора безопасного режима F8**: Повторно включает возможность использования клавиши `F8` при загрузке (только Windows 8 и выше; включено по умолчанию на Server 2012/2012 R2).

8. **Проверка подключения к сети**: Проверяет активное сетевое подключение и пропускает проверку обновлений, если оно не обнаружено.

9. **Проверка обновлений**: Сравнивает локальную копию Tron с версией в официальном репозитории (делается это путем чтения номера последней версии из `sha256sums.txt`). Если локальная копия устарела, Tron предложит автоматически скачать последнюю копию (**всегда** рекомендуется). Если разрешено, он загрузит копию на рабочий стол, проверит хэш SHA256, затем уничтожит (удалит) старую версию.

10. **Обновление списков деблокировки**: Подключение к Github и загрузка последней версии списков деблокировки Этапа 2 при первом запуске. Используйте переключатель `-sdu` (`SKIP_DEBLOAT_UPDATE`), чтобы предотвратить такое поведение. Я рекомендую разрешить Tron обновлять списки, если у вас нет веской, конкретной причины этого не делать.

11. **Обнаружение прав администратора**: Определение, выполняется ли мы от имени администратора, и предупреждение пользователя, если это не так.

12. **Создание записи RunOnce**: Создает следующий реестровый ключ для поддержки возобновления после прерывания: `HKCU\Software\Microsoft\Windows\CurrentVersion\RunOnce /v "*tron_resume" /t REG_SZ /d "%~dp0tron.bat %-resume"`. Префикс `*` в имени ключа заставляет Windows выполнить его в безопасном режиме.

   Примечание: `-resume` — внутренний переключатель, не предназначенный для использования человеком в командной строке. Если вы его используете, что-то сломается, и я буду смеяться над вами.

13. **Проверка SMART**: Выводит состояние SMART всех жестких дисков в системе, а затем отображает предупреждение, если какой-либо диск сообщает один из следующих кодов состояния: `Error`,`Degraded`,`Unknown`,`PredFail`,`Service`,`Stressed`,`NonRecover`

## ЭТАП 0: Подготовка

*[ссылка на код Этапа 0](https://github.com/bmrf/tron/blob/master/resources/stage_0_prep/stage_0_prep.bat)*

1. **Создание точки восстановления системы**: Создает точку восстановления перед запуском. Только для Vista и выше, только для клиентских ОС. Не поддерживается в серверных ОС, и в Windows 10 не работает, если система находится в каком-либо режиме безопасного запуска. Это известная ошибка, и я потратил много часов, пытаясь найти обходное решение, но не смог найти, поэтому, если вам абсолютно необходима точка восстановления системы, рекомендую запускать в нормальном режиме.

2. **[Rkill](http://www.bleepingcomputer.com/download/rkill/)**: Rkill - это инструмент предварительной подготовки против вредоносных программ; он ищет и завершает работу нескольких известных вредоносных программ, которые мешают инструментам удаления. Rkill НЕ завершит процесс, перечисленный в `\resources\stage_0_prep\rkill\rkill_process_whitelist.txt` ([ссылка](https://github.com/bmrf/tron/blob/master/resources/stage_0_prep/rkill/rkill_process_whitelist.txt))

3. **Создание профиля до запуска**: Создает список установленных программ и список всех файлов в системе, чтобы мы могли сравнить позже и точно увидеть, что было удалено

4. **Dump GUID**: Выгружает список всех установленных программных GUID. Эти выгрузки полезны для помощи проекту в укреплении черного списка известно плохих GUID

5. **Dump списка приложений Metro**: Выгружает список всех приложений Metro в системе. Это полезно для помощи проекту в укреплении черного списка приложений Metro для удаления

6. **ProcessKiller**: Утилита, предоставленная [/u/cuddlychops06](https://www.reddit.com/user/cuddlychops06), которая завершает различные процессы пользовательского уровня. Мы используем это, чтобы дополнительно завершить все, что может мешать Tron. ProcessKiller завершит все в пользовательском уровне, ЗА ИСКЛЮЧЕНИЕМ: `ClassicShellService.exe`, `explorer.exe`, `dwm.exe`, `cmd.exe`, `mbam.exe`, `teamviewer.exe`, `TeamViewer_Service.exe`, `Taskmgr.exe`, `Teamviewer_Desktop.exe`, `MsMpEng.exe`, `tv_w32.exe`, `VTTimer.exe`, `Tron.bat`, `rkill.exe`, `rkill64.exe`, `rkill.com`, `rkill64.com`, `conhost.exe`, `dashost.exe`, `wget.exe` . ([ссылка](https://github.com/bmrf/tron/blob/master/resources/stage_0_prep/processkiller/whitelist.txt))

7. **Режим безопасного запуска**: Настройка системы для перезагрузки в безопасном режиме с сетью, если происходит перезагрузка. Убирает это и сбрасывает на обычную загрузку в конце сценария. Достигается с помощью этой команды:
   ```
   bcdedit /set {default} safeboot network
   ```

8. **Настройка системного времени через NTP**: Устанавливает системные часы для синхронизации с серверами NTP в следующем порядке: `2.pool.ntp.org`, `time.windows.com`, `time.nist.gov`

9. **Проверка и восстановление WMI**: Проверяет интерфейс WMI и пытается восстановить его в случае поломки. Tron использует WMI для многих вещей, включая преобразование формата даты ISO, удаление предустановленных программ OEM и различные другие вещи, поэтому его работа критична

10. **[McAfee Stinger](https://www.mcafee.com/en-us/consumer-corporate/mcafee-labs/free-tools/stinger.html)**: Самостоятельный сканер от McAfee для обнаружения вредоносных программ/руткитов/вирусов. Не поддерживает журналы в виде обычного текста, поэтому мы сохраняем журнал в формате HTML в `%LOGPATH%` Tron. Tron запускает Stinger следующим образом:

  ```
  stinger32.exe --GO --SILENT --PROGRAM --REPORTPATH="%LOGPATH%" --RPTALL --DELETE
  ```

11. **[TDSS Killer](http://usa.kaspersky.com/downloads/TDSSKiller)**: Утилита против руткитов от Kaspersky Labs. Tron выполняет TDSSKiller следующим образом:

  ```
  tdsskiller.exe -l %TEMP%\tdsskiller.log -silent -tdlfs -dcexact -accepteula -accepteulaksn
  ```

12. **Резервное копирование реестра**: Использует [erunt](http://www.larshederer.homepage.t-online.de/erunt/) для создания резервной копии реестра перед началом сканирования

13. **VSS purge**: Очищает старый набор файлов службы теневого копирования тома (в основном копии файлов в определенный момент времени). Вредоносное программное обеспечение часто может скрываться здесь

14. **Уменьшение места для системного восстановления**: Ограничивает использование службы восстановления системы только 7% от доступного места на жестком диске

15. **Отключение режима сна**: Tron использует `caffeine.exe` для отключения режима сна при запуске сценария. В конце сценария сбрасываются настройки энергосбережения до значений по умолчанию Windows. Используйте переключатель `-p`, чтобы предотвратить сброс настроек энергосбережения до значений по умолчанию Windows.
