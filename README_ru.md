| Имя | Tron, автоматический скрипт для очистки ПК |
| :--- | :--- |
| Автор | vocatus на [old.reddit.com/r/TronScript](https://old.reddit.com/r/tronscript) (`vocatus.gate@gmail`) // PGP: [0x07d1490f82a211a2](http://pool.sks-keyservers.net:11371/pks/lookup?op=get&search=0x07D1490F82A211A2) |
| Происхождение | Почему такое название? Tron "Борется за пользователя" |

# НЕ СКАЧИВАЙТЕ TRON С GITHUB, ОН НЕ БУДЕТ РАБОТАТЬ!! ВАМ НУЖЕН ПОЛНЫЙ ПАКЕТ ИЗ [r/TronScript](https://old.reddit.com/r/TronScript)

Мне надоело запускать эти утилиты вручную, и я решил просто написать сценарий. Tron - это отличная коллекция пакетных файлов, которые автоматизируют процесс очистки и дезинфекции Windows-машин ([Общие вопросы](https://www.reddit.com/r/TronScript/wiki/index#wiki_cq_.28common_questions.29)). Он строится с учетом мнения сообщества и регулярно обновляется.

# Содержание

1. [Краткое описание использования](#use)

2. [Работа с командной строкой](#command-line-use)

3. [Прерывание работы](#script-interruption)

4. [Заметки по Безопасному режиму](#safe-mode)

5. [Отправка отчета о проделанной работе по электронной почте](#email-report)

6. [Изменение стандартных параметров](#change-defaults-advanced)

7. [Выполнение пользовательских/сторонних сценариев](#executing-3rd-party-custom-scripts)

8. [Выполнение поставляемых обновлений WSUS Offline](executing-bundled-wsus-offline-updates)

9. [Целостность](#integrity)

10. [Лицензия](#license)

11. [Возможные трудности и поддержка](#problems-and-support)

12. [Коды выхода скрипта](#script-exit-codes) 

13. [Полное описание ВСЕХ действий](#full-tron-description)


# ИСПОЛЬЗОВАНИЕ

0. СНАЧАЛА: **ПЕРЕЗАГРУЗИТЕ КОМПЬЮТЕР ПЕРЕД ЗАПУСКОМ TRON.** Это необходимо для завершения всех ожидающих обновлений. Если вы этого не сделаете, и компьютер перезагрузится во время выполнения Tron с ожидающими обновлениями, это может привести к блокировке системы. Повторю: очень важно перезагрузить компьютер перед запуском Tron.

1. [Загрузите Tron](https://old.reddit.com/r/TronScript/). Ссылки для загрузки находятся в верхнем сообщении в [/r/TronScript](https://old.reddit.com/r/TronScript). Если вы загрузили исполняемый файл `.exe`, запустите его, и он извлечет файл `tron.bat` и папку `\resources` в текущий каталог. Скопируйте оба файла на **Рабочий стол** целевой машины.

2. Tron можно запустить в Windows как в безопасном режиме, так и в обычном режиме. Обычный режим рекомендуется, если система серьезно заражена.

3. Щелкните правой кнопкой мыши по файлу `tron.bat` и выберите "**Запуск от имени администратора**"

4. Подождите от **3 до 10 часов** (это действительно занимает столько времени; **не** отменяйте его посередине выполнения)

   *Примечание: Вам нужно будет вручную нажать "Сканировать" в окне MBAM, которое появится на этапе 3: Дезинфекция. Tron будет продолжать выполнение других задач в фоновом режиме, ожидая вашего ответа, поэтому скрипт не остановится, если вы не сможете сразу нажать "Сканировать".*

5. **Перезагрузите!** Перезагрузите систему перед выполнением *любых других действий*.

По умолчанию основной журнал находится по пути `C:\logs\tron\tron.log`. Если вы хотите изменить это, прочтите раздел ниже о изменении настроек по умолчанию.

В зависимости от того, насколько система заражена, выполнение может занять от 3 до 10 часов. Я лично наблюдал время от 4 до 8 часов, и один пользователь сообщил о времени выполнения 30 часов. Просто запустите и забудьте.

Если вы запустите с ключом `-udl`, в конце сценария он автоматически отправит мне журналы выполнения по электронной почте. Не обязательно, но если вы можете, это будет очень ценно.

**ПРИМЕЧАНИЕ:** Каждый подскрипт этапа (например, `stage_2_de-bloat.bat`) может быть запущен отдельно от Tron. Просто не забывайте запускать их от имени администратора, если вы выбираете этот путь.

# ИСПОЛЬЗОВАНИЕ В КОМАНДНОЙ СТРОКЕ

Полная поддержка использования в командной строке. Все переключатели являются необязательными и могут использоваться одновременно. *

    tron.bat [ [-a | -asm] -c -d -dev -e -er -m -o -p -pmb -r -sa -sac -sap -scc -scs -sd -sdb
          -sdc -sdu -se -sk -sl -sm -sor -spr -ss -str -swu -swo -udl -v -x] | [-h]

    Необязательные параметры (их можно комбинировать):

     -a   Автоматический режим (без приветственного экрана или подсказок; подразумевает -e)
     
     -asm Автоматический режим (без подсказок; подразумевает -e; перезагружает в безопасный режим)

     -c   Выгрузка конфигурации (отображение текущей конфигурации. Может использоваться с другими
          параметрами, чтобы увидеть, что БЫ произошло, но скрипт никогда не выполнится,
          если этот переключатель используется)

     -d   Пробный запуск (запустить скрипт без выполнения каких-либо заданий)
    
     -dev Переопределение обнаружения ОС (разрешает запуск на не поддерживаемых версиях Windows)

     -e   Принять условия лицензионного соглашения (подавить экран предупреждения об отказе от ответственности)

     -er  Отправить отчет по электронной почте по завершении. Требует настройки SwithMailSettings.xml

     -m   Сохранить стандартные приложения Metro (не удалять их)

     -o   Выключить после выполнения (переопределяет -r)

     -p   Сохранить настройки энергосбережения (не возвращаться к стандартным настройкам Windows)

     -pmb Сохранить Malwarebytes (не удалять его) после завершения работы Tron
     
     -r   Автоматическая перезагрузка (автоматическая перезагрузка через 15 секунд после завершения)
     
     -sa  Пропустить ВСЕ антивирусные сканирования (AdwCleaner, KVRT, MBAM, SAV)

     -sac Пропустить сканирование AdwCleaner

     -sap Пропустить установку патчей для приложений (не патчить 7-Zip)

     -scs Пропустить пользовательские скрипты (не имеет эффекта, если вы не предоставили пользовательские скрипты)

     -scc Пропустить очистку куки (не рекомендуется, Tron автоматически сохраняет большинство обычных куки входа)

     -sd  Пропустить дефрагментацию (принудительно пропустить дефрагментацию этапа 6)

     -sdb Пропустить де-блокировку (весь процесс удаления OEM-блокировки; подразумевает -m)
     
     -sdc Пропустить очистку компонента DISM (хранилища SxS)
     
     -sdu Пропустить обновление де-блокировки. Предотвращает автоматическое обновление списков де-блокировки S2

     -se  Пропустить резервное копирование и очистку журнала событий (не очищать журналы событий Windows)

     -sk  Пропустить сканирование Kaspersky Virus Rescue Tool (KVRT)

     -sm  Пропустить установку Malwarebytes Anti-Malware (MBAM)

     -sor Пропустить удаление OneDrive, независимо от того, используется он или нет

     -spr Пропустить сброс файла подкачки (не устанавливать "Позволить Windows управлять файлом подкачки")

     -ss  Пропустить сканирование Sophos Anti-Virus (SAV)

     -str Пропустить удаление телеметрии (просто отключите телеметрию, а не удаляйте ее)

     -swu Пропустить обновления Windows полностью (игнорировать как WSUS Offline, так и онлайн методы)

     -swo Пропустить предоставленные пользователем обновления WSUS Offline (если они есть; онлайн обновления все равно выполняются)
     
     -udl Загрузить отладочные журналы. Отправить tron.log и дамп идентификатора системы разработчику Tron

     -v   Развернутый режим. Показывать как можно больше вывода. ПРИМЕЧАНИЕ: Значительно медленнее!

     -x   Автоудаление. Tron удаляет себя после выполнения и оставляет журналы нетронутыми

    Различные параметры (должны использоваться отдельно):

     -h   Показать текст справки


\* Вероятно, нет параметра `-upm`

# ПРЕРЫВАНИЕ СЦЕНАРИЯ

Если сценарий прерывается, например, из-за сбоя или принудительной перезагрузки (часто возникающей на этапе_2_разблокировка), просто повторно запустите `tron.bat`, и Tron возобновит выполнение с последнего успешно запущенного этапа.

Он также повторно использует все ранее использованные параметры командной строки при следующем запуске.

Более подробные сведения об этой функции можно найти в [списке всех действий, выполняемых Tron](#full-tron-description) в конце этого документа.

# БЕЗОПАСНЫЙ РЕЖИМ

В старых версиях Tron (v10.3.1 и ранее) рекомендовался использовать безопасный режим по сравнению с нормальным/обычным режимом (режим загрузки Windows). Текущее рекомендуемое действие изменилось, начиная с v10.4.0, и я рекомендую сначала запускать в нормальном/обычном режиме, и пытаться запустить в безопасном режиме только в случае неудачи.

# EMAIL-ОТЧЕТ

Чтобы Tron отправил отчет по электронной почте по завершении, отредактируйте этот файл:

    \tron\resources\stage_7_wrap-up\email_report\SwithMailSettings.xml

Укажите ваш SMTP-сервер, имя пользователя и пароль. После указания ваших настроек вы можете использовать переключатель `-er`, чтобы Tron отправил отчет по электронной почте. Сводные журналы (`tron_removed_files.txt` и `tron_removed_programs.txt`) также будут прикреплены.

Имейте в виду, что имя пользователя и пароль для учетной записи электронной почты будут храниться в ОБЫЧНОМ ТЕКСТЕ, поэтому не оставляйте их в системе, которой вы не доверяете.

# ИЗМЕНЕНИЕ НАСТРОЕК ПО УМОЛЧАНИЮ (для продвинутых)

Если вы не хотите использовать командную строку и вам не нравятся настройки Tron по умолчанию, вы можете изменить следующие настройки по умолчанию. Имейте в виду, что переключатели командной строки всегда переопределяют соответствующий параметр по умолчанию при использовании.

**Отредактируйте этот файл**: `\tron\resources\functions\tron_settings.bat`

- Чтобы изменить основной каталог, куда Tron выводит все свои данные, отредактируйте эту строку:
  ```bat
  set LOGPATH=%SystemDrive%\logs\tron
  ```

- Чтобы изменить имя основного файла журнала, отредактируйте эту строку:
  ```bat
  set LOGFILE=tron.log
  ```

- Чтобы изменить местоположение файлов, помещенных в карантин Tron (обратите внимание: в настоящее время Tron не использует это, установка не имеет эффекта):
  ```bat
  set QUARANTINE_PATH=%LOGPATH%\quarantine
  ```

- Чтобы изменить расположение резервных копий, создаваемых Tron (реестр, журналы событий, схема питания и т. д.), отредактируйте эту строку:
  ```bat
  set BACKUPS=%LOGPATH%\backups
  ```

- Чтобы изменить место, где Tron сохраняет необработанные журналы из различных подскриптов, отредактируйте эту строку:
  ```bat
  set RAW_LOGS=%LOGPATH%\raw_logs
  ```

- Чтобы изменить, где Tron сохраняет сводные журналы, отредактируйте эту строку:
  ```bat
  set SUMMARY_LOGS=%LOGPATH%\summary_logs
  ```

- Чтобы всегда запускать автоматически (без приветственного экрана, подразумевает принятие EULA), измените это на `yes`:
  ```bat
  set AUTORUN=no
  ```
  
- Чтобы всегда перезагружаться в безопасном режиме для автозапуска (требуется, чтобы AUTORUN также был установлен в `yes`), измените это на `yes`:
  ```bat
  set AUTORUN_IN_SAFE_MODE=no
  ```

- Чтобы выполнить пробный запуск (фактически не выполнять задания), измените это на `yes`:
  ```bat
  set DRY_RUN=no
  ```

- Чтобы переопределить обнаружение ОС (разрешить Tron запускаться на не поддерживаемых версиях Windows), измените это на `yes`:
  ```bat
  set DEV_MODE=no
  ```

- Чтобы постоянно принимать Лицензионное соглашение конечного пользователя (подавлять отображение предупреждения об отказе от ответственности), измените это на `yes`:
  ```bat
  set EULA_ACCEPTED=no
  ```

- Чтобы иметь Tron отправлять отчет по электронной почте по завершении, измените это на `yes` (требует настройки `SwithMailSettings.xml` с вашей информацией SMTP):
  ```bat
  set EMAIL_REPORT=no
  ```

- Чтобы сохранить стандартные приложения Metro (не удалять их), измените это на `yes`:
  ```bat
  set PRESERVE_METRO_APPS=no
  ```

- Чтобы выключить компьютер по завершении Tron, измените это на `yes`:
  ```bat
  set AUTO_SHUTDOWN=no
  ```

- Чтобы сохранить схему энергосбережения (вместо сброса на стандарты Windows), измените это на `yes`:
  ```bat
  set PRESERVE_POWER_SCHEME=no
  ```

- Чтобы сохранить установку Malwarebytes (пропустить удаление) после завершения Tron, измените это на `yes`:
  ```bat
  set PRESERVE_MALWAREBYTES=no
  ```

- Чтобы настроить перезагрузку после выполнения, измените это значение (в секундах). `0` отключает автоматическую перезагрузку:
  ```bat
  set AUTO_REBOOT_DELAY=0
  ```

- Чтобы пропустить ВСЕ движки антивирусного сканирования (AdwCleaner, MBAM, KVRT, Sophos), измените это на `yes`:
  ```bat
  set SKIP_ANTIVIRUS_SCANS=no
  ```

- Чтобы пропустить сканирование AdwCleaner, измените это на `yes`:
  ```bat
  set SKIP_ADWCLEANER_SCAN=no
  ```

- Чтобы пропустить патчи для приложений (не патчить 7-Zip или Adobe Flash), измените это на `yes`:
  ```bat
  set SKIP_APP_PATCHES=no
  ```

- Чтобы оставить ВСЕ куки нетронутыми (не рекомендуется, Tron автоматически сохраняет большинство обычных куки для входа, таких как Spotify, Gmail и т. д.), измените это на `yes`:
  ```bat
  set SKIP_COOKIE_CLEANUP=no
  ```

- Чтобы пропустить пользовательские сценарии (этап 8), независимо от того, присутствуют ли файлы `.bat` в папке `stage_8_custom_scripts`, измените это на `yes`:
  ```bat
  set SKIP_CUSTOM_SCRIPTS=no
  ```

- Чтобы пропустить OEM-разгрузку, измените это на `yes`:
  ```bat
  set SKIP_DEBLOAT=no
  ```

- Чтобы всегда пропускать дефрагментацию (даже на механических дисках; Tron автоматически пропускает дефрагментацию SSD), измените это на `yes`:
  ```bat
  set SKIP_DEFRAG=no
  ```
  
- Чтобы пропустить очистку компонентов DISM (SxS store), измените это на `yes`:
  ```bat
  set SKIP_DISM_CLEANUP=no
  ```
  
- Чтобы предотвратить подключение Tron к Github и автоматическое обновление списков разгрузки 2 этапа, установите это на `yes`:
  ```bat
  set SKIP_DEBLOAT_UPDATE=no
  ```

- Чтобы пропустить очистку журналов событий Windows, измените это на `yes`:
  ```bat
  set SKIP_EVENT_LOG_CLEAR=no
  ```

- Чтобы пропустить сканирование с Kaspersky Virus Rescue Tool (KVRT), измените это на `yes`:
  ```bat
  set SKIP_KASPERSKY_SCAN=no
  ```

- Чтобы пропустить установку Malwarebytes Anti-Malware (MBAM), измените это на `yes`:
  ```bat
  set SKIP_MBAM_INSTALL=no
  ```

- Чтобы пропустить удаление OneDrive, независимо от того, используется он или нет, измените это на `yes`:
  ```bat
  set SKIP_ONEDRIVE_REMOVAL=no
  ```

- Чтобы предотвратить сброс Tron настроек файла подкачки к стандартам Windows, измените это на `yes`:
  ```bat
  set SKIP_PAGEFILE_RESET=no
  ```

- Чтобы пропустить сканирование с Sophos Anti-Virus (SAV), измените это на `yes`:
  ```bat
  set SKIP_SOPHOS_SCAN=no
  ```
  
- Чтобы пропустить удаление обновлений Windows "телеметрии" (отслеживание пользователей), измените это на `yes`:
  ```bat
  set SKIP_TELEMETRY_REMOVAL=no
  ```

- Чтобы пропустить только пакетные обновления WSUS Offline (попытки выполнения обновлений онлайн сохраняются), измените это на `yes`:
  ```bat
  set SKIP_WSUS_OFFLINE=no
  ```

- Чтобы полностью пропустить обновления Windows (игнорировать как WSUS Offline, так и онлайн методы), измените это на `yes`:
  ```bat
  set SKIP_WINDOWS_UPDATES=no
  ```
  
- Чтобы автоматически загружать отладочные журналы разработчику Tron (vocatus), измените это на `yes`:
  ```bat
  set UPLOAD_DEBUG_LOGS=no
  ```

- Чтобы показать как можно больше вывода (подробности), измените это на `yes`:
  ```bat
  set VERBOSE=no
  ```

- Чтобы Tron удалил сам себя после выполнения (самоуничтожение), измените это на `yes`:
  ```bat
  set SELF_DESTRUCT=no
  ```

* Скорее всего, параметра `-UPM` нет

# EXECUTING 3RD-PARTY CUSTOM SCRIPTS: (ПО третьей стороны)

Tron поддерживает запуск сторонних скриптов прямо перед конечным этапом. 

Разместите любой batch файл который хотите запустить после работы Tron в эту директорию:
`\tron\resources\stage_8_custom_scripts`

Запуск сторонних скриптов происходит по схеме:

 - Если в директории имеются любые `.bat` файлы, Tron запустит каждый из них каскадом по имени. Когда скрипты завершат свою работу будет выполнена последняя стадия очистки и обычное завершение Tron. 
 
 - Если в директории нет  `.bat` файлов, стадия `Stage_8_custom_scripts` будет пропущена.
 
 - Необходимые файлы для работы скриптов, находящиеся в той же директории будут проигнорированы. Tron ищет только `.bat` файлы.
 
 - Если Вы хотите использовать дополнительные batch файлы, но не хотите, что бы Tron их выполнял - используйте расширение `.cmd` вместо `.bat` и Tron будет их игнорировать. 
 
 - Ответственность за работу пользовательских скриптов несут сами пользователи. Я не буду оказывать какой либо поддержки, кроме возможности запуска этих самых скриптов. 

 - Используйте `-scs` ключ или отредактируйте файл `\tron\resources\tron_settings.bat` и установите значение `SKIP_CUSTOM_SCRIPTS` на `yes`, что бы заставить tron игнорировать любые пользовательские скрипты, даже если они расположены в правильной директории. Может быть полезно, если вы имеете скрипты только для запуска на определенных машинах и не хотите носить две копии tron с собой. 

# EXECUTING BUNDLED WSUS OFFLINE UPDATES (Выполнение вложенных обновлений WSUS Offline)

Tron поддерживает использование вложенных обновлений WSUS offline также как и традиционные online обновления.

Чтобы добавить offline обновление в Tron:

1. Скачайте [WSUS Offline](http://download.wsusoffline.net/)

2. Запустите и скачайте нужные вам обновления

3. Скопируйте `Client` каталог (обычно он находится в `\wsusoffline\client`) в `\tron\resources\stage_5_patch\wsus_offline\client\`

4. Удостоверьтесь что `update.cmd` расположен по этому пути `\tron\resources\stage_5_patch\wsus_offline\client\Update.cmd`

5. Запустите Tron, он должен автоматически обнаружить обновления

Если по какой-то причине вы желаете пропустить выполение вложенных обновлений WSUS offline на определенной системе, используйте ключ `-swo`. Или отредактируйте [tron_settings.bat](https://github.com/bmrf/tron/blob/master/resources/functions/tron_settings.bat) и установите параметр `SKIP_WSUS_oFFLINE` на `yes` и Tron будет игнорировать WSUS offline. 
 
 
# INTEGRITY (Целостность)

В каждом релизе, файл 
`\tron\integrity_verification\chechsums.txt` содержит SHA-256 хэши *каждого* файла используемого Tron, и подписаны [моим PGP ключем](http://pool.sks-keyservers.net:11371/pks/lookup?op=get&search=0x07D1490F82A211A2) (`0x07d1490f82a211a2`, включительно). Вы можете использовать их для проверки целостности пакетов.


# LICENSE (Лицензия)

Tron и любые используемые им скрипты и `.reg` файлы были написаны мной бесплатно для использования/каких-угодно_действий под лицензией **MIT License**. Было бы очень приятно, если бы вы отправили мне письмо, если делаете/сделали что-то крутое с этим. Но это не обязательно. Все программное обеспечение третьей стороны (MBAM, TSSSK, и т.д.) распространяется отдельно  и имеет свои собственные лицензии. Это ВАША ответственность решать, можете ли вы их использовать в Своих специфических ситуациях.


# Problems AND SUPPORT (Возможные затруднения и поддержка)

Пожалуйста, ознакомьтесь [здесь](https://old.reddit.com/r/TronScript/wiki/index#wiki_cq_.28common_questions.29) со списком часто наиболее частыми затруднениями (Tron, вероятно, завис, и т.д.). Если вы не нашли там рекомендаций по вашей ситуации, создайте пост верхнего уровная в [r/TronScript](https://old.reddit.com/r/TronScript) и я или сообщество вам помогут. Так же я доступен 24/7 [на Keybase](https://keybase.io/vocatus). 

Надеюсь это поможет остальным технарям.

- Vocatus

Если вы чувствуете себя сверх-щедрыми:

Bitcoin: `1Bfxpo1WqTGwRXZKrwYZV2zvJ4ggyj9GE1`

Monero: `4GG9KsJhwcW3zapDw62UaS71ZfFBjH9uwhc8FeyocPhUHHsuxj5zfvpZpZcZFHWpxoXD99MVt6PnR9QfftXDV8s6Hh2QHtyHWnQFDgFUCJ`

# SCRIPT EXIT CODES (Коды выхода скрипта)
Когда Tron завершается, он передает сигнал выхода (успешное завершение/предупреждение/ошика/неудачное завершение/и другое).

| Код       | Значение |
| :--------- | :------ |
| 0 | Success (Успешное завершение)
| 1 | Error (usually fatal) (Фатальная ошибка)
| 2 | Warning (non-fatal) (Предупреждение)
| 3 | Unsupported OS (run with `-dev` to override) (Неподдерживаемая ОС, используйте `-dev`, чтобы избежать проверки версии ОС)
| 4 | Exit pending reboot (Работы закончены, ожидается перезагрузка)
| 5 | User is an idiot (aka you tried running from the temp directory in spite of the instructions clearly saying not to) (Пользователь идиот. Tron был запущен из каталога временных файлов несмотря на то, что в инструкции явно указано этого не делать)

# FULL TRON DESCRIPTION (Полное описание)
Самый простой способ узнать, что делает Tron, это открыть `Tron.bat` или файл определенной стадии с помощью текстового редактора(желательно с подсветкой синтаксиса) или [на GitHub](https://github.com/bmrf/tron/blob/master/tron.bat) и просто читать код. Каждая секция имеет комментарии описывающие действия, поэтому Вам не обязательно быть программистом что бы понять код. В любом случае, не смотря на это, вот общее описание каждого действия скрипта.

## tron.bat

*[Исходный код](https://github.com/bmrf/tron/blob/master/tron.bat)*

Главный скрипт, запускающий все другие инструменты. Он использует большое количество действий сам по себе, но не все задачи мы можем выполнить непосредственно, поэтому вызываем дополнительные инструменты или скрипты. Каждая стадия (STAGE 1: Tempclean) имеет свой собственный мастер-скрипт, который Tron вызывает в цепочке. Скрипты под-стадий могут быть найдены в соответствующей стадии директории по пути `\tron\resources\stage_1_tempclean\stage_1_tempclean.bat`

## Tron-internal prep jobs (подготовительные работы Tron)
(Данные скрипты/инструменты работоспособны даже если Tron не запустил их самостоятельно)

0. **Определение на запуск из TEMP**: Определяет, из какой директории запущен Tron, Если это TEMP, прерывает запуск. TEMP это первое место, которое Tron очищает при запуске, поэтому не может быть запущен оттуда.

1. **Создание лог директорий**: Создает мастер-лог и поддиректории если они не созданы. По умолчанию это `%SystemDrive\Logs\tron.log`
 
2. **Определение версии Windows и Internet Explorer**: Определяет довольно много параметров в сценарии, на пример, какие версии различных команд будут использованы. 

3. **Не поддерживаемая ОС**: Выдает сообщение об ошибке если запуск происходит на не поддерживаемой ОС и прерывается. Используйте флаг `-dev`, что бы отменить эту проверку и разрешить запуск на не поддерживаемой версии windows. 

4. **Определение типа ПЗУ**: Определяет, является ли системный раздел установлен на SSD, виртуальный диск, или выдает ошибки(которые не могу быть определены через `smartctl.exe`). И устанавливает параметр `SKIP_DEFRAG` на `yes_ssd`, `yes_vm`, `yes_error`. Если переменная имеет одно из указаных значений, Tron пропустит **Stage 5: Defrag** автоматически. 

5. **Определяет свободное пространство на диске**: Определяет свободное пространство на диске для будущего сравнения. Просто используется, что бы показать, сколько свободного пространства появилось после проделанной работы. Не влияет на любые функции скрипта.

6. **Определяет факт запуска**: Проверяет была ли работа скрипта продолжена после прерывания, на пример, перезагрузки. 

7. **Включает меню выбора загрузки в Безопасный Режим**: Включает возможность использовать кнопку `F8` при загрузке (Только windows 8/8.1; включено по-умолчанию на server 2012/2012 R2)

8. **Проверка наличия подклчюения с сетью Интернет**: проверяет наличие доступа в сеть Интернет. И отменят проверку обновлений, если соединений нет. 
 
9. **Проверяет на наличие новой версии**: Сравнивает локальные файлы Tron с версией на официальном репозитории (Использует `wget` что бы скачать `sha256sums.txt` с зеркала Tron, и определить, является ли данная версия последней). Если локальная копия Tron является устаревшей, то Вас спросято возможности автоматического обновления. Если ответите ДА, он скачает ее на Рабочий Стол, проверит SHA-256 хэш, и удалит текущую версию.

10. **Обновление списка раздутого ПО**: Устанавливает соединение с GitHub и скачивает последнюю версию списка раздутого ПО для Stage 2 debloat перед запуском. Используйте ключ `-sdu` (`SKIP_DEBLOAT_UPDATE`) для предотвращения подобного поведения. Я рекомендую позволять Tron обновлять данные списки и делать исключения только в случае, если у вас есть на то весомые причины.
 
11. **Проверка наличия прав**: Проверяет наличие прав администратора, в случае отказа, выведет на экран ошибку. 

12. **Создание ключа RunOnce**: Создает соответствующую запись в реестре для последующего запуска после возможного прерывания работы Tron. `HKCU\Software\Microsoft\Windows\CurrentVersion\RunOnce /v "tron_resume" /t REG_SZ /d "%~dp0tron.bat %-resume"`

	Внимание: `-resume` это внутренний флаг и не предназначен для человеческого использования в коммандной строке. Если вы будете его использовать - вы все сломаете и я буду громко смеяться.

13. **Проверка S.M.A.R.T**: Создает дамп SMART статуса всех доступных дисков в системе, и выводит сообщение на экран, в случае если имеется код: `Error`, `Degraded`, `Unknown`, `PredFail`, `Service`, `Stressed`, `NonRecover`.


## STAGE 0: Prep (СТАДИЯ 0: подготовка)

*[Исходный код](https://github.com/bmrf/tron/blob/master/resources/stage_0_prep/stage_0_prep.bat)*


1. **Создает точку восстановления системы**: Создает точку восстановления системы . Только Windows Vista и выше. Не поддерживается на серверных редакциях ОС. Так же не поддерживается на Windows10, если система находится в любой форме безопасного режима. Это известный баг, я потратил много часов пытаясь выяснить откуда он берет начало. Но так и не смог найти решение. Если Вы абсолютно уверены в необходимости создания точки восстановления - рекомендую запускать Tron в нормальном режиме.

2. **[Rkill](http://www.bleepingcomputer.com/download/rkill/)**: Rkill это anti-malware проверочная утилита. Она ищет malware и убивает мешающие инструментам удаления. Rkill игнорирует любой процесс указанный в `\resources\stage_0_prep\rkill\rkill_process_whitelist.txt` 
([ссылка на список](https://github.com/bmrf/tron/blob/master/resources/stage_0_prep/processkiller/whitelist.txt))

3. **Создание профиля до запуска**: Создает дамп всех установленных программ и список всех файлов в системе, что бы была возможность узнать что именно было удалено. 

4. **Дамп GUID**: Создает GUID дамп всех устновленных программ. Эти дампы полезны для проекта, из них собирают черные списки GUID'ов. 

5. **Дамп списка Metro приложений**: Создает список установленных Metro прилоежений. Это помогает проекту bolster обновлять черный список Metro приложений для удаления. 

6. **ProcessKiller**: Утилита предоставленная [/u/cuddlychops06](https://www.reddit.com/user/cuddlychops06) которая убивает ряд процессов запущенных от имени пользователя. Мы используем ее так же, для завершения любых процессов которые могут иметь конфликты с Tron. Конкретно, она завершает все процессы запущенные от имени пользователя, кроме: `ClassicShellService.exe`, `explorer.exe`, `dwm.exe`, `cmd.exe`, `mbam.exe`, `teamviewer.exe`, `TeamViewer_Service.exe`, `Taskmgr.exe`, `Teamviewer_Desktop.exe`, `MsMpEng.exe`, `tv_w32.exe`, `VTTimer.exe`, `Tron.bat`, `rkill.exe`, `rkill64.exe`, `rkill.com`, `rkill64.com`, `conhost.exe`, `dashost.exe`, `wget.exe`

7. **Безопасный Режим**: Вынуждает систему перезагрузиться в безопасный режим с поддержкой сетевых драйверов если происходит перезагрузка. Tron самостоятельно убирает данные настройки и восстанавливает значения по-умолчанию в конце работы скрипта. Вызывается командой:
	```
	bcdedit /set {default} safeboot network
	```

8. **Устанавливает системное время через NTP**: Синхронизирует системные часы с time.nist.gov, 3.pool.ntp.org, time.windows.com

9. **Проверяет и восстанавливает WMI**: Проверяет WMI интерфейс и восстанавливает если поврежден. Tron использует WMI для многих целей, включая конвертацию формата даты в ISO, для полного удаления раздутого ПО, и для других различных задач. Критически необходимо для работы Tron.

10. **[McAfee Stinger](http://www.mcafee.com/us/downloads/free-tools/stinger.aspx)**: Anti-Malware/rootkit/virus самостоятельный сканер от McAfee. Не поддерживает ведение лога открытым текстом, так что мы используем HTML логи в `%LOGPATH%` Tron'а. Tron запускает Stinger через:
	```
	stinger32.exe --GO --SILENT --PROGRAM --REPORTPATH="%LOGPATH%" --RPTALL --DELETE
	```

11. **[TDSS Killer](http://usa.kaspersky.com/downloads/TDSSKiller)**: Anti-rootkit утилита от Лаборатории Касперского. Tron запускает командой:
	```
	dsskiller.exe -l %TEMP%\tdsskiller.log -silent -tdlfs -dcexact -accepteula -accepteulaksn
	```

12. **Бэкап реестра. Используется [erunt](http://www.larshederer.homepage.t-online.de/erunt/)**: 
Используется для создания бекапа реестра.

13. **VSS purge**: Безвозвратно удаляет скрытые файлы, которые являются старой резервной копией файлов. Malware часто могут прятаться именно там.

14. **Изменяет данные о размере места для восстановления системы**: Изменяет настройки системы, что бы она использовала для восстановления 7% от доступного свободного места на диске.

15. **Отключает спящий режим**: Tron использует `caffeine.exe` для отключения спящего режима когда скрипт стартует. В конце скрипта он сбрасывает настройки питания Windows на настройки по-умолчанию. Использование флага `-p` в скрипте Tron предотвращает сброс настроек питания.


## STAGE 1: TempClean (СТАДИЯ 1: Очистка временных файлов)

*[Ссылка на исходный код Stage 1](https://github.com/bmrf/tron/blob/master/resources/stage_1_tempclean/stage_1_tempclean.bat)*

1. **Очистка Internet Explorer**: Запускает встроенную в Windows функцию очистки и сброса настроек IE (Выполняется только для  Internet Explorer v7 и выше):
	```
	rundll32.exe inetcpl.cpl,ClearMyTracksByProcess 4351
	```
	
2. **[CCLeaner](https://www.piriform.com/ccleaner)**: Утилита для очистки временных файлов. Запуск производиться перед запуском AV сканнеров. Учтите, что CCleaner удаляет содержимое `%AppData%` с локального хранилища. Отредактируйте [ccleaner.ini](https://github.com/bmrf/tron/blob/master/resources/stage_1_tempclean/ccleaner/ccleaner.ini) и измените `(App)Local Storage*=True` на `(App)Local Storage*=False` если вам хотите избежать такого поведения. Так же учитывайте, что это нужно будет сделать и для BleachBit (описание доступно ниже)

3. **[TempFileCleanup.bat](https://github.com/bmrf/tron/blob/master/resources/stage_1_tempclean/tempfilecleanup/TempFileCleanup.bat)**: Лично мной написанный скрипт, который очищает файлы/директории которые другие утилиты пропускают.

4. **[USB Device Cleanup.exe](http://www.uwe-sieber.de/drivetools_e.html#drivecleanup)**: Удаляет неиспользуемые\давно_не_используемые драйверы_USB. Использует `drivecleanup.exe` от [Uwe SIeber](http://www.uwe-sieber.de/)

5. **Удаление дубликатов загруженных файлов**: Ищет и удаляет дубликаты в директории Загрзки всех пользователей (`ChromeInstaller(1).exe`, `ChromeInstaller(2).exe`, и т.д.) Использует утилиту [Find Dupe](http://www.sentex.net/~mwandel/finddupe/) от Sentex.

6. **Очистка журнала событий Windows**: Делает резервную копию журнала событий по умолчанию в '%LOGPATH%', после удаляет записи из журнала.

7. **Очистка кэша Windows Update**: Безвозвратно удаляет файлы установки для уже установленных обновлений. Обычно освобождает немного пространства на диске.

	```
	rmdir /s /q %windir%\softwaredistribution\download
	```

8. **Стирание кэша BranchCache**: Tron исполняет команду `netsh branchcache flush` чтобы стареть кэшированные данные в BranchCache (Только Windows 7 и выше)


## STAGE 2: De-bloat (СТАДИЯ 2:Удаление раздутого ПО)

*[Исходный код](https://github.com/bmrf/tron/blob/master/resources/stage_2_de-bloat/stage_2_de-bloat.bat)*


1. **OEM De-bloat** (по имени): использует WMI для удаления любой программы указанной в [этом файле](https://github.com/bmrf/tron/blob/master/resources/stage_2_de-bloat/oem/programs_to_target_by_name.txt):
	```
	\tron\resources\stage_2_de-bloat\oem\programs_to_target_by_name.txt
	```

2. **OEM de-bloat** (по GUID): Использует WMI для удаления программ указанных в [этом файле](https://github.com/bmrf/tron/blob/master/resources/stage_2_de-bloat/oem/programs_to_target_by_GUID.bat):
	```
	\tron\resources\stage_2_de-bloat\oem\programs_to_target_by_GUID.bat
	```

3. **Toolbar & BHOs** (по GUID): Использует WMI для удаления программ указанных в [этом файле](https://github.com/bmrf/tron/blob/master/resources/stage_2_de-bloat/oem/toolbars_BHOs_to_target_by_GUID.bat): 
	```
	\resources\stage_3_de-bloat\toolbars_BHOs_to_target_by_GUID.bat
	```

4. **Metro de-bloat**: Удаляет пред. установленные Metro-приложения которые никто не использует. (Не удаляет такие приложения как Калькулятор, Paint) Потом удаляет их из кэша(Вы всегда можете вернуть их позже через Windows Update). На Windows 8/8.1 удаляет весь стэк "современных" приложений. На Windows10 и выше - удаляет только некоторые специфичные приложения. Полный список удаляемых приложений можно посмотреть [здесь](https://github.com/bmrf/tron/blob/master/resources/stage_2_de-bloat/metro/metro_Microsoft_modern_apps_to_target_by_name.ps1) (Microsoft) и [здесь](https://github.com/bmrf/tron/blob/master/resources/stage_2_de-bloat/metro/metro_3rd_party_modern_apps_to_target_by_name.ps1) (OEM/Третья сторона). Используйте `-sdb` ключ (пропустить *всю* очистку от раздетого программного обеспечения") или `-m` ключ (пропустить только удаление Metro-приложений) для отключения действия. Так же как и список GUID выше, вы можете отредактировать эти файлы для добавления или удаления приложений из списка. Учитывайте, что PowerShell скрипт с удалением Metro приложений поддерживает запуск без основного скрипта, к примеру, если вы хотите *только* удалить Metro приложения.

5. ** Удаление интеграции OneDrive**: Принудительно и беспощадно удаляет интеграцию OneDrive (Только для Windows 10). Tron сначала проверяет наличие любых файлов в OneDrive директории по умолчанию (`%USERPROFILE%\OneDrive\`) и пропускает удаление если файлы имеются. Как дополнительная мера предосторожности - Tron оставляет директорию OneDrive нетронутой независимо, была ли удалена ли интеграция. Используйте ключ `-sor`, чтобы исключить удаление OneDrive в любых сценариях.

## STAGE 3: Disinfect (СТАДИЯ 3: Дезинфекция)

*[Исходный код](https://github.com/bmrf/tron/blob/master/resources/stage_3_disinfect/stage_3_disinfect.bat)*

1. **[Очистка CryptNet SSL кэша](https://github.com/bmrf/tron/issues/86)**: Очищает CryptNet SSL кэш сертификатов выполняя терм: `certutil -URLcache * delete`

2. **[Malwarebytes Anti-Malware](https://www.malwarebytes.org/)**: Anti-Malware сканнер. Из-за отсутствия поддержки командной строки для MBAM, мы просто установили его и продолжили дальше по скрипту. Таким образом, техник может нажать **SCAN** когда хочет, но скрипт не остановиться в ожидании ввода. Использование флагов `-sa` или `-sm` задаст пропуск этого компонента.

3. **[KVRT](http://www.kaspersky.com/antivirus-removal-tool)**: Virus Remoal Tool от Лаборатории Касперского. Используйте флаги `-sa` или `-sk` для пропуска запуска данного компонента. Tron запускает его как:

4. **[Sophos Virus Removal Tool](https://www.sophos.com/en-us/products/free-tools/virus-removal-tool.aspx)**: антивирусный сканер с поддержкой командной строки. Использование флага `-v` даст больше информации о сканировании. Использование флагов `-sa` или `-ss` отменит запуск данного компонента.


## STAGE 4: Repair (Стадия 4: Восстановление)

*[Исходный код](https://github.com/bmrf/tron/blob/master/resources/stage_4_repair/stage_4_repair.bat)*

0. **Удаление установщиков msi**: использует `msizap.exe` утилиту от Microsoft для удаления установленных msi пакетов из кэша установщика. 

1. **[System File Checker](https://support.microsoft.com/en-us/kb/929833)**: Утилита от Microsoft для проверки файловой системы на наличие ошибок и автоматическое исправление оных если таковые будут обнаружен. Tron запускает данную утилиту только на Windows Vista и выше (XP и ниже требуют перезагрузки)

2. **DISM image check & repair**: Утилита проверки Windows Image Store от Microsoft(Одна из самых мощных проверочных утилит файловой системы). Только windows 8 и выше.

3 **chkdsk**: Проверяет диск на ошибки и вносит chkdsk в загрузку для последующего исправления оных (устанавливает метку dirty на раздел). 

4. **Отключение средств телеметрии Windows**: Отключает телеметрию Windows(отслеживание действий пользователя), Только Windows 7 и выше. Если скрипт запущен на windows 7/8/8.1, Tron удаляет "плохие" обновления Microsoft, которые выпущены для этих версий с целью включения телеметрии в них. Tron удаляет эти обновления из windows 7/8/8.1. Tron так же отключает и удаляет `DiagTrack`(Диагностическая отслеживающая служба) службу. Если скрипт запущен под управлением Windows 10, Tron делает более глубокую очистку телеметрии Windows. Подробности смотрите в коде [7/8/8.1](https://github.com/bmrf/tron/blob/master/resources/stage_4_repair/disable_windows_telemetry/purge_windows_7-8-81_telemetry.bat), [Win10](https://github.com/bmrf/tron/blob/master/resources/stage_4_repair/disable_windows_telemetry/purge_windows_10_telemetry.bat) что бы увидеть что именно будет удалено и отключено. Если запуск происходит на Windows10 - Tron делает более глубокую работу по отключению телеметрии, включая включение иммунитета от [Spybot Anti-Beacon](https://www.safer-networking.org/spybot-anti-beacon/) и [O&O ShutUp10](https://www.oo-software.com/en/shutup10). Код можно посмотреть в `\tron\resources\stage_4_repair\disable_windows_telemetry\`. ВАЖНО: этот процесс занимает некоторое время, НЕ ПРЕРЫВАЙТЕ ЕГО. Используйте флаг `-str`, что бы пропустить данную операцию.

5. **Отключение обновления до Windows 10**: Отключает уведомление об обновлении для Windows 7/8/8.1 изменяя значения реестра. Пользователи все еще могут обновить систему если пожелают через панель управления. Но не через трэй, авто-загрузку, авто-установку windows 10 без их согласия. 

6. **Восстановление работы сети**: Tron делает мелкие восстановления конфигурации сети. Точнее, он запускает: `ipconfig /flushdns`,	`netsh interface ip delete arpcache`, `netsh winsock reset catalog`

7. **Восстановление файлов расширений**: Tron восстанавливает стандартные файлы расширений с помощью batch файла который зациклено просматривает файлы реестра сохраненные в:`\tron\resources\stage_4_repair\repair_file_extensions\`


## STAGE 5: Patch (СТАДИЯ 5: Патч)

*[Исходный код](https://github.com/bmrf/tron/blob/master/resources/stage_5_patch/stage_5_patch.bat)*

Tron обновляет эти программы. Если программа не установлена - патч пропускается:

1. **[7-Zip](http://7-zip.org/faq.html)**: Программа с открытым исходным кодом для сжатия и извлечения файлов. Всеядна, употребляет даже WinRAR). Используйте флаг `-sp`, что бы отменить данную операцию.

2. **Adobe Flash Player**: Используется для воспроизведения медиа-контента в сети. Используйте флаг `-sp`, что бы отменить данную операцию.

3. **Windows Update**: Запускает Windows Update с помощью: `wuauclt /detectnow /updatenow`. Используйте ключ `-sw`, что бы пропустить данную операцию.

4. **DISM base reset**: Пересобирает "Windows Image Store" (SxS store) после того как мы ранее закончили удалять старые файлы. Только Windows 8 и выше. Обычно они занимают много места. Любое установленное обновление *близкое* к данной точке будет неудаляемым. Используйте ключ `-sdc` для отмены действия. 


## STAGE 6: Optimize (СТАДИЯ 6: Оптимизация)

*[Исходный код](https://github.com/bmrf/tron/blob/master/resources/stage_6_optimize/stage_6_optimize.bat)*

1. **Сбрасывает файл подкачки**: Сбрасывает настройки файла подкачки до "Пускай Windows управляет файлом подкачки". Приводиться в действие с помощью:

	`%WMIC% computersystem where name="%computername%" set AutomaticManagedPagefile=True`

	Используйте флаг `-spr`, что бы пропустить данную операцию.


2. **[Defraggler](https://www.piriform.com/defraggler)**: утилита от Piriform для дефрагментации с поддержкой командной строки. Немного быстрее чем встроенная в Windows утилита. Автоматически пропускается если обнаружен SSD. Используйте флаг `-sd`, что бы пропустить данную операцию. 


## STAGE 7: Wrap-up (СТАДИЯ 7: Сводка)

*Специфический код для каждой стадии в [tron.bat](https://github.com/bmrf/tron/blob/master/tron.bat)*

1. **Генерация общего лога**: Генерация общих лог-файлов до и после развернутой информации о удаленных файлах и программах. Находятся по адресу: `<LOGPATH>\tron_summary_logs`. Дополнительно, если был установлен флаг `-er`, или настроен `EMAIL_REPORT`, эти логи будут прикреплены с письмом. 

2. **Создает точку восстановления**: Создает точку восстановления после проделанной работы, что бы отразить ту, которую мы создали на в Stage 0: Prep (Стадия 0: Подготовка). Только Vista и выше, только клиентские ОС, на Windows 10 не работает если система в любой форме Безопасного Режима. Смотрите заметки по Восстановлению системы в документации по Stage 0.

3. **оповещение письмом**: Отправляет письмо с лог-файлами когда Tron закончит. Требует настройки SMTP в `\resources\stage_7_wrap-up\email_report\SwithMailSettings.xml`

4. **Выгрузка бэбаг логов**: Выгружает `tron.log` и системный GUID дамп ( Список всех GUID установленных программ) к разработчику Tron (Vocatus). Пожалуйста, используйте эту опцию если возможно. Данные логи очень полезны в разработке Tron! ВАЖНО: имейте ввиду, что `tron.log` может содержать персональную информацию, такую как Имена и имена файлов в системе, имя компьютера, имя пользователя и т.д. Так что, если Вы обеспокоены данным фактом - пожалуйста, просмотрите сначала лог Tron, что бы понять что именно будет отправлено. Мне не важны файлы на рандомных компьютерах в сети, только уведомляю Вас, что бы вы знали. 


## STAGE 8: Custom Scripts (Стадия 8: Запуск сторонних скриптов)

*Код данной стадии находится в [Tron.bat](https://github.com/bmrf/tron/blob/master/tron.bat)*

1. **Запуск сторонних скриптов**: Tron запустит любой `.bat` файл находящийся в `tron\resources\stage_8_custom_scripts` директории. Посмотрите на [Запуск сторонних скриптов](#executing-3rd-party-custom-scripts) выше для более полной картины  о происходящем. 

## STAGE 9: Manual Tools (СТАДИЯ 9: Дополнительные инструменты)

Tron не запускает их автоматически, из-за того, что они не поддерживают командную строку, или полезны в специфических ситуациях. 

1. **[ADSSpy](http://www.bleepingcomputer.com/download/ads-spy/)**: Сканирует на наличие скрытых NTFS разделов. 

2. **[AdwCleaner](https://toolslib.net/downloads/viewdownload/1-adwcleaner/)**: Популярная программа для удаления таргетированной рекламы.

3. **[aswMBR](http://public.avast.com/~gmerek/aswMBR.htm)**: Rootkit сканнер.

4. **[autoruns](https://technet.microsoft.com/en-us/sysinternals/bb963902.aspx)**: Изучает и удаляет программы из автозагрузки.

5. **[ComboFix](http://www.combofix.org/)**: Руководствуется "Политикой Выжженой Земли" в процессе обнаружения malware. Работает только на windows xp, vista, 7. Не работает на windows 8 и выше.

6. **[PCHunter](http://www.majorgeeks.com/files/details/pc_hunter.html)**: Утилита сканирует на наличие rootkit`ов и других подозрительных вещей. Замещает собой gmer.

7. **[Junkware Removal Tool](http://thisisudax.org/)**: Временных файлов и рандомных рекламных баннеров удалитель.

8. **[Net Adapter Repair](http://www.bleepingcomputer.com/download/netadapter-repair-all-in-one/)**: Утилита для восстановления большинства проблем соединений windows.

9. **Remote Support Reboot Config**: Утилита для быстрого конфигурирования авто-логина и других параметров для запуска Tron через удаленное соединение. Спасибо reddit.com/user/cuddlychops06

10. **Safe Mode Boot Selector.bat**: batch файл бля быстрого выбора режима загрузки. (Безопасный Режим, с поддержкой сетевых драйверов и т.д.) Спасибо reddit.com/user/cuddlychops06

11. **ServicesRepair.exe**: утилита от ESET для восстановления сломанных\не_работающих служб Windows. 

12. **Tron Reset Tool**:Утилита для быстрого восстановления Tron, если скрипт поврежден или прерывается во время работы.
